<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license
Copyright (c) 2016 Hemant Jadon. All rights reserved.
-->

<!-- Polymer and PolymerElements -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<!-- Custom Web Components -->
<link rel="import" href="../app-user/app-user.html">


<dom-module id="app-login">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      .container{
        height: 100vh;
        width: 100%;
        margin-top: -64px;
      }
      @media(max-width : 600px){
        .container{
          margin-top: -56px;
        }
      }
      .container .wrapper{
        width: 100%;
        max-width: 600px;
        margin: 20px 20px;
        border: 1px solid #e3e5e7;
        border-radius: 5px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      }
      .wrapper .ribbon{
        width: 100%;
        height: 3px;
        background: var(--accent-color)
      }
      .wrapper .inner-wrapper{
        padding: 20px;
      }
      .inner-wrapper > span{
        font-size: 2.5em;
        color: #bdbdbd;
      }
      .inner-wrapper .credentials{
      }
      .credentials paper-input{
        --paper-input-container-focus-color : var(--accent-color);
      }
      .login-button paper-button{
        margin: 20px 0px;
        border: 1px solid #e3e5e7;
        border-radius: 5px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        --paper-button-ink-color : var(--accent-color);
        font-size: 1.2em;
        --paper-button-keyboard-focus : {
          background : var(--accent-color);
          color: white;
        };
      }

      div.non_field_errors,div.username_error,div.password_error{
        color: red;
        margin: 10px 0px;
      }
    </style>

    <app-user user="{{user}}"></app-user>

    <iron-ajax id="login_ajax"
      url="{{loginUrl}}"
      handle-as="json"
      method="POST"
      content-type="application/json"
      body="{{_getRequestBody(credential_username,credential_password)}}"
      last-error="{{error}}"
      last-response="{{response}}"
      on-response="handleResponse"
      on-error="handleError"></iron-ajax>

    <template id="login_page" is="dom-if" if="{{!user.is_authenticated}}">
      <div class="container layout horizontal center around-justified">
        <div class="wrapper">
          <div class="ribbon"></div>
          <div class="inner-wrapper">
            <span>Login</span>
            <div class="non_field_errors" hidden$="{{!login_form_non_field_errors}}">
              {{login_form_non_field_errors}}
            </div>
            <div class="credentials">
              <div class="username_error" hidden$="{{!login_form_username_error}}">
                {{login_form_username_error}}
              </div>
              <paper-input label="Username" value="{{credential_username}}"></paper-input>
              <div class="password_error" hidden$="{{!login_form_password_error}}">
                {{login_form_password_error}}
              </div>
              <paper-input label="Password" type="password" value="{{credential_password}}"></paper-input>
            </div>
            <div class="login-button layout horizontal">
              <paper-button class="layout flex" role="submit" on-tap="submitForm">Login</paper-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Auth0 jwt-decode package -->
      <script type="text/javascript" src="../../bower_components/jwt-decode/build/jwt-decode.min.js"></script>
    </template>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'app-login',

      properties: {
        user : {
          type : Object,
          notify : true,
          observer : "userChanged"
        },
        credential_username : {
          type : String,
        },
        credential_password : {
          type : String,
        },
        loginUrl : {
          type : String,
          value : "http://localhost:8000/api-token-auth/"
        }
      },

      userChanged(){
        if (this.user) {
          if (this.user.is_authenticated) {
            console.warn("User already authenticated !! --> TODO");
            // TODO : Redirect here to homepage or any other location.
          }
        }
      },
      _getRequestBody(username,password){
        return JSON.stringify({username : username , password : password});
      },
      submitForm(){
        this.$.login_ajax.generateRequest();
      },
      handleResponse(evt){
        let token = evt.detail.response.token;
        let decoded_token = jwt_decode(token);
        let user = {
          user_id : decoded_token.user_id,
          username : decoded_token.username,
          email : decoded_token.email,
          token : token,
          expires_at : decoded_token.expires_at,
          is_anonymous : false,
          is_authenticated : true,
          is_admin : decoded_token.is_staff
        }
        this.set('user',user);
        window.location = `${window.location.origin}`;
      },
      handleError(evt){
        console.log(this.error);
        if (this.error.status === 400) {
          let error_response = this.error.response;
          if (error_response.non_field_errors) {
            this.login_form_non_field_errors = error_response.non_field_errors;
          }
          if (error_response.username) {
            this.login_form_username_error = error_response.username;
          }
          if (error_response.password) {
            this.login_form_password_error = error_response.password;
          }
        }
      },
    });
  })();
  </script>
</dom-module>
