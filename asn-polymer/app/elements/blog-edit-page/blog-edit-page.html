<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license
Copyright (c) 2016 Hemant Jadon. All rights reserved.
-->

<!-- Polymer and PolymerElements -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<!-- Custom Web Components -->
<link rel="import" href="../blog-edit-header/blog-edit-header.html">
<link rel="import" href="../blog-editor/blog-editor.html">

<dom-module id="blog-edit-page">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      paper-progress {
        width: 100%;
        --paper-progress-active-color: var(--accent-color);
        --paper-progress-container-color: var(--header-accent-color);
      }
      header#backgroundHeader{
        height: 500px;
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        padding-top: 64px;
        z-index: -1;
      }
      @media(max-width: 600px){
        header#backgroundHeader{
          padding-top: 56px;
        }
      }
      .blog-content-container{
        max-width: 900px;
        margin: 0 auto;
      }
      .blog-text-container{
        background: var(--primary-background-color);
        border: 1px solid #e3e5e7;
        box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        margin: 10px 30px;
        position: relative;
      }
    </style>

    <iron-ajax id="console_feed_ajax"
      auto
      url="{{consoleBlogUrl}}"
      content-type="application/json"
      handle-as="json"
      loading="{{loading}}"
      headers="{{getRequestHeaders(user)}}"
      last-response="{{blog}}"
      last-error="{{error}}"
      on-error="handleError">
    </iron-ajax>

    <paper-progress indeterminate hidden$={{!loading}}></paper-progress>

    <template id="error" is="dom-if" if="{{loadError}}">
      {{loadError.status}}
    </template>

    <template id="blog" is="dom-if" if="{{blog}}">
      <div class="container">
        <header class="paper-header" id="backgroundHeader" style$="{{__getBackgroundColor(blog)}}">
        </header>
        <div class="blog-content-container">
          <blog-edit-header blog="{{blog}}"></blog-edit-header>
          <div class="blog-text-container">
            <blog-editor blog="{{blog}}"></blog-editor>
          </div>
        </div>
      </div>
    </template>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'blog-edit-page',

      properties: {
        /**
         * Blog Id of the blog to edit.
         * It is set by the host elememt.
         * @type {Object}
         */
        blogId : {
          type : String,
          notify : true
        },

        /**
         * API endpoint for getting the the blog to edit.
         * It is a computed method depending on blogId.
         * @type {Object}
         */
        consoleBlogUrl : {
          type : String,
          computed : "computeUrl(blogId)"
        },

        /**
         * Blog response from server after iron-ajax request.
         * @type {Object}
         */
        blog : {
          type : Object,
          notify : true,

        },

        /**
         * Loading state of the iron-ajax.
         * Used to display paper-progress.
         * @type {Object}
         */
        loading : {
          type : Boolean,
          value : false
        }
      },

      computeUrl(blogId){
        return `http://localhost:8000/api/blogs/author-only/${blogId}/`;
      },

      getRequestHeaders(user){
        return {'Authorization': `JWT ${user.token}`};
      },

      handleError(evt){
        console.log(this.error);
        if (this.error.status === 401) {
          console.error("You are not authorized to view this page.",user);
        }
      },

      __getBackgroundColor(blog) {
        return `background:${blog.header_color_hash}`;
      }
    });
  })();
  </script>
</dom-module>
